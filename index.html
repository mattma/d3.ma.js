<!doctype html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>D3 Test</title>

	<link rel="stylesheet" type="text/css" href="src/d3.ma.css">

	<script src="libs/d3.v3.js"></script>
	<script src="libs/d3.chart.js"></script>


	<script src="src/common/core.js"></script>
	<script src="src/common/utils.js"></script>
	<script src="src/common/container.js"></script>
	<script src="src/components/clippath.js"></script>


	<script src="src/core/scale.js"></script>
	<script src="src/core/base.js"></script>


	<script src="src/components/axis.js"></script>


	<script src="src/basic/bars.js"></script>

<!--
	<script src="build/d3.ma.min.js"></script>
-->

</head>
<body>
	<div id="vis"></div>

	<script>
		var data = [
			{
				"label" : "A" ,
				"value" : 29.765957771107
			} ,
			{
				"label" : "B" ,
				"value" : 0
			} ,
			{
				"label" : "C" ,
				"value" : 32.807804682612
			} ,
			{
				"label" : "D" ,
				"value" : 196.45946739256
			} ,
			{
				"label" : "E" ,
				"value" : 0.19434030906893
			} ,
			{
				"label" : "F" ,
				"value" : 98.079782601442
			} ,
			{
				"label" : "G" ,
				"value" : 13.925743130903
			} ,
			{
				"label" : "H" ,
				"value" : 5.1387322875705
			}
		];
	</script>

	<script>
		// http://jsbin.com/isawar/4/edit

		// TODO: Move the onData, onInsert, onEnter, etc
		// to the prototype level, so do not need to defined in each one
		// d3.selection.prototype.layer = function(options) {
		// 	//d3.selection.prototype.layer.call(this, options);
		// 	return this;
		// };

		function domain(context) {
			// Setup xScale domain range
			context.xScale.domain(d3.merge(data).map(function(d) { return d.label }));
			// Setup yScale domain range
			var maxY = Math.round( d3.max( data.map(function(val, ind){ return val.value;  }) ) );
			context.yScale.domain([ 0, maxY ]);
		}

		d3.chart('Axis').extend('MyAxis', {
			onDataBind: function(chart){
				var chart = chart || this;
				domain(chart);
				chart.yAxis.tickFormat(d3.format(',.1f'));
			}
		});

		d3.chart('Bars').extend('MyBars', {
			onDataBind: function(chart) {
				var chart = chart || this;
				domain(chart);
			},

			onEnter: function(chart, single) {
				var chart = chart || this,
					color = d3.scale.category10();

				single.attr({
					'x': function(d, i) { return chart.xScale(d.label); },
					'y': function(d) { return chart.yScale(d.value); },
					'width': function(d) { return chart.xScale.rangeBand() ; },
					'height': function(d) { return chart.height - chart.yScale(d.value); },
					'fill': function(d) { return color(d.value); }
				});
			},

			onDataMouseover: function(d, i, chart) {
				var chart = chart || this;
				var obj = {
					'value': d.value,
					'pointIndex': i,
					'd': d,
					'event': d3.event,
					'pos': [
						chart.xScale(d.label) + (chart.xScale.rangeBand() / 2),
						chart.yScale(d.value)
					]
				};
				return obj;
			}
		});

		d3.chart("FinalChart", {
			// margin:  access container margin info  top, right, bottom, left
			initialize: function(containerInfo) {
				// Used for the clipPath object
				// var clip =  this.mixin("Clip",  this.base);
				// clip.box(300, 600).xy(0, 50);

				var axis =  this.mixin("MyAxis",  this.base.append("g").classed('axisgroup', true), {
					info: containerInfo,
					x: 'ordinal',
					width: this.base.attr('width'),
					height: this.base.attr('height'),
					guide: true
				});

				axis.xLabel('matt ma').yLabel('yes, sir');

				var bars = this.mixin("MyBars", this.base.append('g').classed('bars', true), {
					info: containerInfo,
					x: 'ordinal',
					width: this.base.attr('width'),
					height: this.base.attr('height'),

				});

				// Tooltip section
				var tooltip = d3.ma.tooltip(this.base);
				bars.dispatch.on('d3maMouseover', function(e){
					e.pos = [ e.pos[0] + 40, e.pos[1] + 30 ];
					var html = "<div class='tips'>" + e.d.label + "<br><strong>" + e.d.value + "</strong>" + "</div>"
					//tooltip.show([e.pos[0], e.pos[1]], html, d3.ma.$$('#vis'));
					tooltip.show([e.pos[0], e.pos[1]], html);
				});

				bars.dispatch.on('d3maMouseout', function(e){
					tooltip.close();
				});
			}

		});

		var container = d3.ma.container('#vis');

		container.resize().box(1400, 600);

		var canvas = container.canvas().chart("FinalChart", container.info() );

		//render it with some data
		canvas.draw(data);

	</script>

	<!-- livereload snippet  -->
	<script src="http://localhost:35729/livereload.js?snipver=1"></script>
</body>
</html>
