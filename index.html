<!doctype html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>D3 Test</title>
	<script type="text/javascript" src="http://code.jquery.com/jquery-1.7.2.min.js"></script>
	<script src="libs/d3.v3.js"></script>
	<script src="libs/d3.chart.js"></script>


	<script src="src/common/core.js"></script>
	<script src="src/common/utils.js"></script>
	<script src="src/common/container.js"></script>
	<script src="src/common/clippath.js"></script>

	<script src="src/components/axis.js"></script>

	<script src="src/basic/base.js"></script>

<!--
	<script src="build/d3.ma.min.js"></script>
-->
	<style>
		svg {
			font: 10px sans-serif;
		}
		.line {
			fill: none; stroke: #000; stroke-width: 1.5px;
		}
		.axis path, .axis line {
			fill: none; stroke: #000; shape-rendering: crispEdges;
		}
		#vis {
			width: 1400px;
			height: 600px;
		}

		.guide .tick {
			stroke: lightgrey;
			opacity: 0.5;
		}
		.guide path {
			stroke-width: 0;
		}

		/********************
		 * TOOLTIP CSS
		 */

		 .d3maTooltip-pending-removal {
			position: absolute;
			pointer-events: none;
		}

		.d3maTooltip {
			position: absolute;
			background-color: rgba(255,255,255,0.75);
			padding: 1px;
			text-align: center;
			border: 1px solid rgba(0,0,0,.2);
			z-index: 10000;

			font-family: Arial;
			font-size: 13px;
			-moz-box-shadow: 0 5px 10px rgba(0,0,0,.2);
			-webkit-box-shadow: 0 5px 10px rgba(0,0,0,.2);
			box-shadow: 0 5px 10px rgba(0,0,0,.2);

			-webkit-border-radius: 6px;
			-moz-border-radius: 6px;
			border-radius: 6px;

			pointer-events: none;

			-webkit-touch-callout: none;
			-webkit-user-select: none;
			-khtml-user-select: none;
			-moz-user-select: none;
			-ms-user-select: none;
			user-select: none;
		}
		rect:hover {
			fill-opacity: 1;
		}
		</style>
</head>
<body>
	<div id="vis"></div>

	<script>
		// http://jsbin.com/isawar/4/edit


		// TODO:
		// Also update the box(), width(), height()
		//update the scale width and height, bar width and height for resize service

		// TODO: Move the onData, onInsert, onEnter, etc
		// to the prototype level, so do not need to defined in each one
		// d3.selection.prototype.layer = function(options) {
		// 	//d3.selection.prototype.layer.call(this, options);

		// 	return this;
		// };

		// define a new chart type: a circle chart
		d3.chart("BarChart", {

			initialize: function() {

				var color = d3.scale.category10();

				var width = this.base.attr('width'),
					height = this.base.attr('height');

				this.yScale = d3.scale.linear()
								.range([height, 0]);

				this.xScale = d3.scale.ordinal()
								.rangeRoundBands([0, width], 0.1);

				this.dispatch = d3.dispatch('d3maMouseover', 'd3maMouseout');

				// create a layer of circles that will go into
				// a new group element on the base of the chart
				this.layer("bars", this.base, {

					// select the elements we wish to bind to and
					// bind the data to them.
					dataBind: function(data) {
						var chart = this.chart();

						chart.xScale.domain(d3.merge(data).map(function(d) { return d.label }));

						var maxY = Math.round( d3.max( data.map(function(val, ind){ return val.value;  }) ) );
						chart.yScale.domain([ 0, maxY ]);

						return this.selectAll(".group").data(data);
					},

					// insert actual bars
					insert: function() {
						return this.append('g').classed('group', true).append('rect');
					},

					// define lifecycle events
					events: {

						// paint new elements, but set their radius to 0
						// and make them red
						"enter": function() {
							var chart = this.chart();

							this.attr({
								'x': function(d, i) { return chart.xScale(d.label); },
								'y': function(d) { return chart.yScale(d.value); },
								'width': function(d) { return chart.xScale.rangeBand() ; },
								'height': function(d) { return height - chart.yScale(d.value); },
								'fill': function(d) { return color(d.value); },
								'fill-opacity': 0
							});

							this.on('mouseover', function(d, i){
								d3.select(this).classed('hover', true);
								var obj = {
									'value': d.value,
									'pointIndex': i,
									'd': d,
									'event': d3.event,
									'pos': [
										chart.xScale(d.label) + (chart.xScale.rangeBand() / 2),
										chart.yScale(d.value)
									]
								};

								chart.dispatch.d3maMouseover(obj);
							});

							this.on('mouseout', function(d, i){
								d3.select(this).classed('hover', false);
								var obj = {
									'value': d.value,
									'pointIndex': i,
									'd': d,
									'event': d3.event,
									'pos': [
										chart.xScale(d.label) + chart.xScale.rangeBand() / 2,
										chart.yScale(d.value)
									]
								};

								chart.dispatch.d3maMouseout(obj);
							});
						},

						'enter:transition': function() {
							var chart = this.chart();
							return this
								.duration(1000)
								.attr({
									'fill-opacity': 0.8
								})
						}
					}
				});
			},
			width: function(newWidth) {
				if (arguments.length === 0) {
						return this._width;
				}
				this._width = newWidth;
				this.base.attr("width", this._width);
				this.xScale.range([0, this._width]);
				return this;
			}
		});

		d3.chart("FinalChart", {
			initialize: function() {

				// Used for the clipPath object
				// var clip =  this.mixin("Clip",  this.base);
				// clip.box(600, 500).xy(400, 50);
				//
				var base = this.mixin('Base', this.base.append('g').classed('base', true), {
					width: 1000,
					height: 200
				});

				var axisG = this.base.append("g").classed('axisgroup', true);

				var barsG = this.base.append("g").classed('bars', true).attr({
					'width': this.base.attr('width'),
					'height': this.base.attr('height')
					//'clip-path': clip.url()
				});


				var axis =  this.mixin("Axis",  axisG, {
					x: 'ordinal',
					guide: true,
					width: this.base.attr('width'),
					height: this.base.attr('height')
				});

				axis.onData = function(){
					axis.xScale.domain(d3.merge(data).map(function(d) { return d.label }));

					axis.yAxis.tickFormat(d3.format(',.1f'));
					var maxY = Math.round( d3.max( data.map(function(val, ind){ return val.value;  }) ) );
					axis.yScale.domain([ 0, maxY ]);
				};


				var bars = this.mixin("BarChart", barsG);

				var tooltip = d3.ma.tooltip(this.base);

				// Tooltip section
				bars.dispatch.on('d3maMouseover', function(e){
					//console.log('e: ', e);
					e.pos = [ e.pos[0] + 40, e.pos[1] + 30 ];
					var html = "<div class='tips'>" + e.d.label + "<br><strong>" + e.d.value + "</strong>" + "</div>"
					//tooltip.show([e.pos[0], e.pos[1]], html, d3.ma.$$('#vis'));
					tooltip.show([e.pos[0], e.pos[1]], html);
				});

				bars.dispatch.on('d3maMouseout', function(e){
					tooltip.close();
				});

			}

		});



	// // render() won't call by default, developer has to call it manually in each instance.
	// // The reason for that, it will avoid multiple rendering when switch the scale context
	// render: function() {
	// 	// As long as you define, onData, onInsert, onEnter, it would be called in the
	// 	// appropriate section, and auto render the fn for you. You just need to define the fn
	// 	// Need to include the custom behavior to those fn block
	// 	// axis.onData = function() { }
	// 	// axis.onInsert = function() { }
	// 	// axis.onEnter = function() { }


	// 	// create a labels layer
	// 	// this.layer('guidline', this.base, {
	// 	// 	dataBind: function(data) {
	// 	// 		var chart = this.chart();

	// 	// 		// Used onData to override any default behavior for
	// 	// 		// xScale, yScale, xAxis, yAxis etc.
	// 	// 		if(chart.onData) { chart.onData(); }

	// 	// 		return this.select('.guides').selectAll('g').data(data);
	// 	// 	},

	// 	// 	insert: function(){
	// 	// 		var chart = this.chart();
	// 	// 		if(chart.onInsert) { chart.onInsert(); }

	// 	// 		return this.append('g').style('display', 'none');
	// 	// 	},

	// 	// 	events: {
	// 	// 		'enter': function() {
	// 	// 			var chart = this.chart();

	// 	// 			//Acutally draw the xAxis, yAxis on the screen
	// 	// 			chart.xAxisG.call( chart.xAxis);
	// 	// 			chart.yAxisG.call( chart.yAxis);

	// 	// 			// Any additional onEnter behavior
	// 	// 			// would add here,
	// 	// 			// E.G, draw guides fn could be called here
	// 	// 			if(chart.onEnter) { chart.onEnter(); }
	// 	// 		}
	// 	// 	}
	// 	// });
	// },



		var container = d3.ma.container('#vis');

		container.resize().box(1400, 600);

		var canvas = container.canvas().chart("FinalChart");

		var data = [
			{
				"label" : "A" ,
				"value" : 29.765957771107
			} ,
			{
				"label" : "B" ,
				"value" : 0
			} ,
			{
				"label" : "C" ,
				"value" : 32.807804682612
			} ,
			{
				"label" : "D" ,
				"value" : 196.45946739256
			} ,
			{
				"label" : "E" ,
				"value" : 0.19434030906893
			} ,
			{
				"label" : "F" ,
				"value" : 98.079782601442
			} ,
			{
				"label" : "G" ,
				"value" : 13.925743130903
			} ,
			{
				"label" : "H" ,
				"value" : 5.1387322875705
			}
		];

		//render it with some data
		canvas.draw(data);

	</script>

	<!-- livereload snippet  -->
	<script src="http://localhost:35729/livereload.js?snipver=1"></script>
</body>
</html>
