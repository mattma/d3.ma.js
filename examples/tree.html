<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>D3 Tree</title>

  <link rel="stylesheet" type="text/css" href="../src/d3.ma.css">

  <style>
    .group {
      cursor: pointer;
    }

    .group circle {
      fill: #fff;
      stroke: steelblue;
      stroke-width: 1.5px;
    }

    .group text {
      font: 10px sans-serif;
    }

    .link {
      fill: none;
      stroke: #ccc;
      stroke-width: 1.5px;
    }
  </style>

  <script src="../libs/d3.v3.js"></script>

  <script src="../src/lib/d3chart.js"></script>
  <script src="../libs/lodash.js"></script>
  <script src="../src/common/core.js"></script>
  <script src="../src/common/utils.js"></script>
  <script src="../src/common/container.js"></script>
  <script src="../src/components/clippath.js"></script>

  <script src="../src/core/scale.js"></script>
  <script src="../src/core/base.js"></script>

  <script src="../src/basic/diagonalLine.js"></script>
  <script src="../src/basic/tree.js"></script>

  <!-- NEVER EVER INCLUDE THIS FILE IN THE BUILD -->
  <script src="../src/common/development.js"></script>

  <!-- <script src="../build/d3.ma.js"></script> -->
</head>
<body>
<div id="vis"></div>

<script type="text/javascript">
  var data =
  {
    "name":     "flare",
    "children": [
      {
        "name":     "vis",
        "children": [
          {
            "name":     "axis",
            "children": [
              {"name": "axis 1 ", "size": 1302},
              {"name": "axis 2", "size": 24593},
              {"name": "axis 3", "size": 652},
              {"name": "axis 4", "size": 636},
              {"name": "axis 5", "size": 6703}
            ]
          },
          {
            "name":     "data",
            "children": [
              {"name": "data 1", "size": 20544},
              {"name": "data 2", "size": 19788},
              {"name": "data 3", "size": 10349},
              {"name": "data 4", "size": 3301},
              {"name": "data 5", "size": 19382},
              {
                "name":     "render",
                "children": [
                  {"name": "render 1", "size": 698},
                  {"name": "render 2", "size": 5569},
                  {"name": "render 3", "size": 353},
                  {"name": "render 4", "size": 2247}
                ]
              },
              {"name": "ScaleBinding", "size": 11275},
              {"name": "Tree", "size": 7147},
              {"name": "TreeBuilder", "size": 9930}
            ]
          },
          {
            "name":     "events",
            "children": [
              {"name": "events 1", "size": 2313},
              {"name": "events 2", "size": 1880},
              {"name": "events 3", "size": 1701},
              {"name": "events 4", "size": 1117}
            ]
          },
          {
            "name":     "legend",
            "children": [
              {"name": "Legend 1", "size": 20859},
              {"name": "LegendItem 2", "size": 4614},
              {"name": "LegendRange 3", "size": 10530}
            ]
          },
          {
            "name":     "operator",
            "children": [
              {
                "name":     "distortion",
                "children": [
                  {"name": "distortion 1", "size": 4461},
                  {"name": "distortion 2", "size": 6314},
                  {"name": "distortion 3", "size": 3444}
                ]
              },
              {
                "name":     "encoder",
                "children": [
                  {"name": "encoder 1", "size": 3179},
                  {"name": "encoder 2", "size": 4060},
                  {"name": "encoder 3", "size": 4138},
                  {"name": "encoder 4", "size": 1690},
                  {"name": "encoder 5", "size": 1830}
                ]
              },
              {
                "name":     "filter",
                "children": [
                  {"name": "FisheyeTreeFilter", "size": 5219},
                  {"name": "GraphDistanceFilter", "size": 3165},
                  {"name": "VisibilityFilter", "size": 3509}
                ]
              },
              {"name": "IOperator", "size": 1286},
              {
                "name":     "label",
                "children": [
                  {"name": "Labeler", "size": 9956},
                  {"name": "RadialLabeler", "size": 3899},
                  {"name": "StackedAreaLabeler", "size": 3202}
                ]
              },
              {
                "name":     "layout",
                "children": [
                  {"name": "AxisLayout", "size": 6725},
                  {"name": "BundledEdgeRouter", "size": 3727},
                  {"name": "CircleLayout", "size": 9317},
                  {"name": "CirclePackingLayout", "size": 12003},
                  {"name": "DendrogramLayout", "size": 4853},
                  {"name": "ForceDirectedLayout", "size": 8411},
                  {"name": "IcicleTreeLayout", "size": 4864},
                  {"name": "IndentedTreeLayout", "size": 3174},
                  {"name": "Layout", "size": 7881},
                  {"name": "NodeLinkTreeLayout", "size": 12870},
                  {"name": "PieLayout", "size": 2728},
                  {"name": "RadialTreeLayout", "size": 12348},
                  {"name": "RandomLayout", "size": 870},
                  {"name": "StackedAreaLayout", "size": 9121},
                  {"name": "TreeMapLayout", "size": 9191}
                ]
              },
              {"name": "Operator", "size": 2490},
              {"name": "OperatorList", "size": 5248},
              {"name": "OperatorSequence", "size": 4190},
              {"name": "OperatorSwitch", "size": 2581},
              {"name": "SortOperator", "size": 2023}
            ]
          },
          {"name": "Visualization", "size": 16540}
        ]
      }
    ]
  };
</script>

<script>
  function setupTreeData (data, chart, context) {
    var info = context.info;
    var tree = d3.layout.tree()
      .size([info.canvasH, info.canvasW]);
    var nodes = tree.nodes(data).reverse();
    var links = tree.links(nodes);

    // Normalize for fixed-depth.
    nodes.forEach(function (d) {
      d.y = d.depth * 180;
    });

    // attach nodes to the context, so it could be reused
    // inside other methods like `onEnter`
    chart.nodes = nodes;

    return {
      nodes: nodes,
      links: links
    };
  }

  function stashOldPosition (context) {
    // Stash the old positions for transition.
    context.nodes.forEach(function (d) {
      d.x0 = d.x;
      d.y0 = d.y;
    });
  }

  function setLineStartLocation (chart, single, context) {
    var height = context.info.canvasH;

    single.attr("d", function (d) {
      // from the center of the tree, animate to the point
      var originalPosition = {
        x: height / 2,
        y: 0
      };
      return chart.diagonal({
        source: originalPosition,
        target: originalPosition
      });
    });
  }

  d3.chart('Tree').extend('MyTree', {
    onDataBind: function (data, chart) {
      var chart = chart || this;
      var dataSet = setupTreeData(data, chart, this);
      return dataSet.nodes;
    },

    onEnter: function (chart, single) {
      var chart = chart || this;

      single.append("circle")
        .attr("r", 1e-6)
        .style("fill", function (d) {
          return d._children ? "lightsteelblue" : "#fff";
        });

      single.append("text")
        .attr("x", function (d) {
          return d.children || d._children ? -10 : 10;
        })
        .attr("dy", ".35em")
        .attr("text-anchor", function (d) {
          return d.children || d._children ? "end" : "start";
        })
        .text(function (d) {
          return d.name;
        })
        .style("fill-opacity", 1e-6);

      stashOldPosition(chart);
    },

    onInsert: function (chart, single) {
      var chart = chart || this;
      var height = chart.info.canvasH;

      // Enter any new nodes at the parent's previous position.
      var treeNode = single.append("g")
        .attr("class", "node")
        .attr("transform", function (d) {
          if (!d.x0 && !d.y0) {
            d.x0 = height / 2;
            d.y0 = 0;
          }
          return "translate(" + d.y0 + "," + d.x0 + ")";
        })
        .on("click", click);

      chart.treeNode = treeNode;
    },

    onEnterTransition: function (chart, single) {
      var chart = chart || this;
      var duration = chart.options.animationDuration || 750;
      single
        .duration(duration)
        .attr("transform", function (d) {
          return "translate(" + d.y + "," + d.x + ")";
        });

      single.select("circle")
        .attr("r", 5)
        .style("fill", function (d) {
          return d._children ? "lightsteelblue" : "#fff";
        });

      single.select("text")
        .style("fill-opacity", 1);
    },

    onRemove: function (chart, single) {
      // Note done yet. @TODO
      var chart = chart || this;

      single
        .duration(400)
        .attr("transform", function (d) {
          return "translate(" + d.y + "," + d.x + ")";
        })
        // .ease('cubic-in')
        // .style('opacity', 1e-6)
        .remove();

      single.select("circle")
        .attr("r", 1e-6);

      single.select("text")
        .style("fill-opacity", 1e-6);
    }
  });

  d3.chart('DiagonalLine').extend('ConnectPath', {
    onDataBind: function (data, chart) {
      var chart = chart || this;
      var dataSet = setupTreeData(data, chart, this);
      return dataSet.links;
    },

    onEnter: function (chart, single) {
      var chart = chart || this;
      setLineStartLocation(chart, single, this);
      stashOldPosition(chart);
    }

    //    onRemove: function (chart, single) {
    //      var chart = chart || this;
    //
    //      // Note done yet. @TODO
    //      single
    //        .duration(400)
    //        .ease('cubic-in-out')
    //        .attr("d", function (d) {
    //          var o = {x: source.x, y: source.y};
    //          return diagonal({source: o, target: o});
    //        })
    //        .remove();
    //    }
  });

  d3.chart("FinalChart", {
    initialize: function (containerInfo) {
      // Used for the clipPath object
      // var clip =  this.mixin("Clip", this.base);
      // clip.box(300, 600).xy(0, 50);

      this.mixin("MyTree", this.base.append('g').classed('tree', true), {
        info:              containerInfo,
        animationDuration: 750
      });

      this.mixin("ConnectPath", this.base.append('g').classed('path', true), {
        info:              containerInfo,
        animationDuration: 750
      });

      // Handle resize in utils.js
      // convininent methods to recall onResize()
      // d3.ma.resize(axis, bars);

      // Tooltip section
      // var tooltip = d3.ma.tooltip(this.base);
      // bars.dispatch.on('d3maMouseenter', function(e){
      //   e.pos = [ e.pos[0] + 40, e.pos[1] + 30 ];
      //   var html = "<div class='tips'>" + e.d.label + "<br><strong>" + e.d.value + "</strong>" + "</div>"
      //   //tooltip.show([e.pos[0], e.pos[1]], html, d3.ma.$$('#vis'));
      //   tooltip.show([e.pos[0], e.pos[1]], html);
      // });

      // bars.dispatch.on('d3maMouseout', function(e){
      //   tooltip.close();
      // });
    }
  });

  var container = d3.ma.container('#vis').margin({left: 50});

  container.box(1400, 600);  //.resize()

  var canvas = container.canvas().chart("FinalChart", container.info());
  var dataset;

  function collapse (d) {
    if (d.children) {
      d._children = d.children;
      d._children.forEach(collapse);
      d.children = null;
    }
    return d;
  }

  //    var source = {
  //      children: [{
  //        a: 1,
  //        depth: 1,
  //        children: [{
  //          b:     1,
  //          depth: 2,
  //          children: [{
  //            c:     1,
  //            depth: 3
  //          }]
  //        }]
  //      }]
  //    };

  var children = d3ma.map(data.children, collapse);
  var dataSet = data;
  // getting the update data with collapse operation
  dataSet.children = children;

  //render it with some data
  canvas.draw(dataSet);

  // d3.csv("/api/gov.csv", function(d) {
  //   // console.log('d: ', d);
  //   return {

  //   };
  // }, function(error, rows) {
  //   console.log(rows);
  // });

  // Toggle children on click.
  function click (d) {

//    _.each(dataSet.children, function (d, i) {
//      if (d.name === dp.name) {
//        console.log('fire me');
//        if (d.children) {
//          d._children = d.children;
//          d.children = null;
//        } else {
//          d.children = d._children;
//          d._children = null;
//        }
//        console.log('d: ', d);
//      }
//    });

    console.log('d.children: ', d.children);
    if (d.children) {
      d._children = d.children;
      d.children = null;
    } else {
      d.children = d._children;
      d._children = null;
    }

    console.log('dataSet: ', dataSet);

    canvas.draw(d);
  }
</script>

<!-- livereload snippet  -->
<script src="http://localhost:35729/livereload.js?snipver=1"></script>


</body>
</html>
