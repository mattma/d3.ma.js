<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>D3 Tree</title>

  <link rel="stylesheet" type="text/css" href="../src/d3.ma.css">

  <style>
    .node {
      cursor: pointer;
    }

    .node circle {
      fill: #fff;
      stroke: steelblue;
      stroke-width: 1.5px;
    }

    .node text {
      font: 10px sans-serif;
    }

    .link {
      fill: none;
      stroke: #ccc;
      stroke-width: 1.5px;
    }
  </style>

  <script src="../libs/d3.v3.js"></script>

  <script src="../src/lib/d3chart.js"></script>
  <script src="../libs/lodash.js"></script>
  <script src="../src/common/core.js"></script>
  <script src="../src/common/utils.js"></script>
  <script src="../src/common/container.js"></script>
  <script src="../src/components/clippath.js"></script>

  <script src="../src/core/scale.js"></script>
  <script src="../src/core/base.js"></script>

  <script src="../src/basic/diagonalLine.js"></script>
  <script src="../src/basic/tree.js"></script>

  <!-- NEVER EVER INCLUDE THIS FILE IN THE BUILD -->
  <script src="../src/common/development.js"></script>

  <!-- <script src="../build/d3.ma.js"></script> -->
</head>
<body>
<div id="vis"></div>

<script type="text/javascript">
  var data =
  {
    "name":     "flare",
    "children": [
      {
        "name":     "util",
        "children": [
          //          {"name": "Arrays", "size": 8258},
          //          {"name": "Colors", "size": 10001},
          //          {"name": "Dates", "size": 8217},
          //          {"name": "Displays", "size": 12555},
          //          {"name": "Filter", "size": 2324},
          //          {"name": "Geometry", "size": 10993},
          //          {
          //            "name":     "heap",
          //            "children": [
          //              {"name": "FibonacciHeap", "size": 9354},
          //              {"name": "HeapNode", "size": 1233}
          //            ]
          //          },
          //          {"name": "IEvaluable", "size": 335},
          //          {"name": "IPredicate", "size": 383},
          //          {"name": "IValueProxy", "size": 874},
          //          {
          //            "name":     "math",
          //            "children": [
          //              {"name": "DenseMatrix", "size": 3165},
          //              {"name": "IMatrix", "size": 2815},
          //              {"name": "SparseMatrix", "size": 3366}
          //            ]
          //          },
          //          {"name": "Maths", "size": 17705},
          //          {"name": "Orientation", "size": 1486},
          //          {
          //            "name":     "palette",
          //            "children": [
          //              {"name": "ColorPalette", "size": 6367},
          //              {"name": "Palette", "size": 1229},
          //              {"name": "ShapePalette", "size": 2059},
          //              {"name": "SizePalette", "size": 2291}
          //            ]
          //          },
          //          {"name": "Property", "size": 5559},
          //          {"name": "Shapes", "size": 19118},
          //          {"name": "Sort", "size": 6887},
          //          {"name": "Stats", "size": 6557},
          {"name": "Strings", "size": 22026}
        ]
      },
      {
        "name":     "vis",
        "children": [
          {
            "name":     "axis",
            "children": [
              {"name": "axis 1 ", "size": 1302},
              {"name": "axis 2", "size": 24593},
              {"name": "axis 3", "size": 652},
              {"name": "axis 4", "size": 636},
              {"name": "axis 5", "size": 6703}
            ]
          },
          //          {
          //            "name":     "data",
          //            "children": [
          //              {"name": "data 1", "size": 20544},
          //              {"name": "data 2", "size": 19788},
          //              {"name": "data 3", "size": 10349},
          //              {"name": "data 4", "size": 3301},
          //              {"name": "data 5", "size": 19382},
          //              {
          //                "name":     "render",
          //                "children": [
          //                  {"name": "render 1", "size": 698},
          //                  {"name": "render 2", "size": 5569},
          //                  {"name": "render 3", "size": 353},
          //                  {"name": "render 4", "size": 2247}
          //                ]
          //              },
          //              {"name": "ScaleBinding", "size": 11275},
          //              {"name": "Tree", "size": 7147},
          //              {"name": "TreeBuilder", "size": 9930}
          //            ]
          //          },
          //          {
          //            "name":     "events",
          //            "children": [
          //              {"name": "events 1", "size": 2313},
          //              {"name": "events 2", "size": 1880},
          //              {"name": "events 3", "size": 1701},
          //              {"name": "events 4", "size": 1117}
          //            ]
          //          },
          //          {
          //            "name":     "legend",
          //            "children": [
          //              {"name": "Legend 1", "size": 20859},
          //              {"name": "LegendItem 2", "size": 4614},
          //              {"name": "LegendRange 3", "size": 10530}
          //            ]
          //          },
          //          {
          //            "name":     "operator",
          //            "children": [
          //              {
          //                "name":     "distortion",
          //                "children": [
          //                  {"name": "distortion 1", "size": 4461},
          //                  {"name": "distortion 2", "size": 6314},
          //                  {"name": "distortion 3", "size": 3444}
          //                ]
          //              },
          //              {
          //                "name":     "encoder",
          //                "children": [
          //                  {"name": "encoder 1", "size": 3179},
          //                  {"name": "encoder 2", "size": 4060},
          //                  {"name": "encoder 3", "size": 4138},
          //                  {"name": "encoder 4", "size": 1690},
          //                  {"name": "encoder 5", "size": 1830}
          //                ]
          //              },
          //              {
          //                "name":     "filter",
          //                "children": [
          //                  {"name": "FisheyeTreeFilter", "size": 5219},
          //                  {"name": "GraphDistanceFilter", "size": 3165},
          //                  {"name": "VisibilityFilter", "size": 3509}
          //                ]
          //              },
          //              {"name": "IOperator", "size": 1286},
          //              {
          //                "name":     "label",
          //                "children": [
          //                  {"name": "Labeler", "size": 9956},
          //                  {"name": "RadialLabeler", "size": 3899},
          //                  {"name": "StackedAreaLabeler", "size": 3202}
          //                ]
          //              },
          //              {
          //                "name":     "layout",
          //                "children": [
          //                  {"name": "AxisLayout", "size": 6725},
          //                  {"name": "BundledEdgeRouter", "size": 3727},
          //                  {"name": "CircleLayout", "size": 9317},
          //                  {"name": "CirclePackingLayout", "size": 12003},
          //                  {"name": "DendrogramLayout", "size": 4853},
          //                  {"name": "ForceDirectedLayout", "size": 8411},
          //                  {"name": "IcicleTreeLayout", "size": 4864},
          //                  {"name": "IndentedTreeLayout", "size": 3174},
          //                  {"name": "Layout", "size": 7881},
          //                  {"name": "NodeLinkTreeLayout", "size": 12870},
          //                  {"name": "PieLayout", "size": 2728},
          //                  {"name": "RadialTreeLayout", "size": 12348},
          //                  {"name": "RandomLayout", "size": 870},
          //                  {"name": "StackedAreaLayout", "size": 9121},
          //                  {"name": "TreeMapLayout", "size": 9191}
          //                ]
          //              },
          //              {"name": "Operator", "size": 2490},
          //              {"name": "OperatorList", "size": 5248},
          //              {"name": "OperatorSequence", "size": 4190},
          //              {"name": "OperatorSwitch", "size": 2581},
          //              {"name": "SortOperator", "size": 2023}
          //            ]
          //          },
          {"name": "Visualization", "size": 16540}
        ]
      }
    ]
  };
</script>

<script>
  var i = 0;
  
  // Compute the new height, function counts total children of root node and sets tree height accordingly.
  // This prevents the layout looking squashed when new nodes are made visible or looking sparse when nodes are removed
  // This makes the layout more consistent.
  var levelWidth = [1];
  var childCount = function(level, n) {
    if (n.children && n.children.length > 0) {
      if (levelWidth.length <= level + 1) levelWidth.push(0);

      levelWidth[level + 1] += n.children.length;
      n.children.forEach(function(d) {
        childCount(level + 1, d);
      });
    }
  };

  // Ex: levelWidth value: [1,2,3,5]. // total have 4 depth; depth 3 has 5 child;

  // get the highest value out of all depths
  // then calculate a dynamic height
  // 150 pixels per line
  childCount(0, data);
  var dynamicHeight = d3.max(levelWidth) * 150;
  var dynamicWidth = (levelWidth.length + 2)  * 180;

  function setupTreeData (data, chart, context) {
    var info = context.info;
    var tree = d3.layout.tree()
      .size([info.canvasH, info.canvasW]);

    var nodes = tree.nodes(data).reverse();

    // Normalize for fixed-depth.
    nodes.forEach(function (d) {
      d.id = d.id || ++i;
      d.y = d.depth * 180;
    });

    var links = tree.links(nodes);

    // attach nodes to the context, so it could be reused
    // inside other methods like `onEnter`
    chart.nodes = nodes;

    return {
      nodes: nodes,
      links: links
    };
  }

  function stashOldPosition (context) {
    // Stash the old positions for transition.
    context.nodes.forEach(function (d) {
      d.x0 = d.x;
      d.y0 = d.y;
    });
  }

  function setupStartAnimationPoint (data, chart) {
    chart.curX = (data.clickedElement) ? data.clickedElement.x0 : data.x0;
    chart.curY = (data.clickedElement) ? data.clickedElement.y0 : data.y0;
  }

  d3.chart('Tree').extend('MyTree', {
    onDataBind: function (data, chart) {
      var chart = chart || this;
      var dataSet = setupTreeData(data, chart, this);
      setupStartAnimationPoint(data, chart);
      return dataSet.nodes;
    },

    onInsert: function (chart, node) {
      var chart = chart || this;
      var height = chart.info.canvasH;

      // Enter any new nodes at the parent's previous position.
      // controlling animate the content from left to right
      node
        .attr("transform", function (d) {
          return "translate(" + chart.curY + "," + chart.curX + ")";
        })
        .on("click", click);
    },

    onEnter: function (chart, single) {
      var chart = chart || this;

      single.append("circle")
        .attr("r", 1e-6)
        .style("fill", function (d) {
          return d._children ? "lightsteelblue" : "#fff";
        });

      single.append("text")
        .attr("x", function (d) {
          return d.children || d._children ? -10 : 10;
        })
        .attr("dy", ".35em")
        .attr("text-anchor", function (d) {
          return d.children || d._children ? "end" : "start";
        })
        .text(function (d) {
          return d.name;
        })
        .style("fill-opacity", 1e-6);
    },

    onEnterTransition: function (chart, single) {
      var chart = chart || this;
      var duration = chart.options.animationDuration || 750;
      single
        .duration(duration)
        .attr("transform", function (d) {
          return "translate(" + d.y + "," + d.x + ")";
        });

      single.select("circle")
        .attr("r", 5)
        .style("fill", function (d) {
          return d._children ? "lightsteelblue" : "#fff";
        });

      single.select("text")
        .style("fill-opacity", 1);
    },

    onMerge: function (chart, single) {
      var chart = chart || this;
      single.select("circle")
        .style("fill", function (d) {
          return d._children ? "lightsteelblue" : "#fff";
        });

      stashOldPosition(chart);
    },

    onMergeTransition: function (chart, single) {
      var chart = chart || this;
      var duration = chart.options.animationDuration || 750;
      single
        .duration(duration)
        .attr("transform", function (d) {
          return "translate(" + d.y + "," + d.x + ")";
        });
    },

    onRemove: function (chart, single) {
      var chart = chart || this;

      single
        .duration(300)
        .ease('cubic-in-out')
        .attr("transform", function (d) {
          return "translate(" + chart.curY + "," + chart.curX + ")";
        })
        .remove();
    },

    onDataMouseenter: function (d, i, chart) {
      var chart = chart || this;
      var obj = {
        'label':      "Name: " + d.name,
        'value':      "showing some value",
        'pointIndex': i,
        'd':          d,
        'event':      d3.event,
        'pos':        [d.y + 80, d.x + 20]
      };
      return obj;
    }
  });

  function setLineStartLocation (chart, single, context) {
    var chart = chart || this;

    single.attr("d", function (d) {
      // from the center of the tree, animate to the point
      var originalPosition = {
        x: chart.curX,
        y: chart.curY
      };
      return chart.diagonal({
        source: originalPosition,
        target: originalPosition
      });
    });
  }

  d3.chart('DiagonalLine').extend('ConnectPath', {
    onDataBind: function (data, chart) {
      var chart = chart || this;
      var dataSet = setupTreeData(data, chart, this);
      setupStartAnimationPoint(data, chart);
      return dataSet.links;
    },

    onInsert: function (chart, path) {
      var chart = chart || this;
      setLineStartLocation(chart, path, this);
    },

    onEnterTransition: function (chart, single) {
      var chart = chart || this;
      var duration = chart.options.animationDuration || 750;
      var easing = chart.options.animationEasing || 'cubic-in-out';

      single
        .duration(duration)
        .ease(easing)
        .attr({'d': chart.diagonal});
    },


    onMerge: function (chart, single) {
      var chart = chart || this;
      stashOldPosition(chart);
    },

    onMergeTransition: function (chart, single) {
      var chart = chart || this;
      var duration = chart.options.animationDuration || 750;
      var easing = chart.options.animationEasing || 'cubic-in-out';

      single
        .duration(duration)
        .ease(easing)
        .attr({'d': chart.diagonal});
    },

    onRemove: function (chart, single) {
      var chart = chart || this;

      single
        .duration(300)
        .ease('cubic-in-out')
        .attr("d", function (d) {
          var o = {x: chart.curX, y: chart.curY};
          return chart.diagonal({source: o, target: o});
        })
        .remove();
    }
  });

  d3.chart("FinalChart", {
    initialize: function (containerInfo) {
      // Used for the clipPath object
      // var clip =  this.mixin("Clip", this.base);
      // clip.box(300, 600).xy(0, 50);

      this.mixin("ConnectPath", this.base.append('g').classed('path', true), {
        info:              containerInfo,
        animationDuration: 750
      });

      var tree = this.mixin("MyTree", this.base.append('g').classed('tree', true), {
        info:              containerInfo,
        animationDuration: 750
      });

      // Handle resize in utils.js
      // convininent methods to recall onResize()
      // d3.ma.resize(axis, bars);

      // Tooltip section
      var tooltip = d3.ma.tooltip(this.base);
      tree.dispatch.on('d3maMouseenter', function (e) {
        var html = "<div class='tips'>" + e.label + "<br><strong>" +
          e.value + "</strong>" + "</div>";
        tooltip.show([e.pos[0], e.pos[1]], html);
      });

      tree.dispatch.on('d3maMouseout', function (e) {
        tooltip.close();
      });
    }
  });

  var container = d3.ma.container('#vis').margin({left: 50});
  container.box(dynamicWidth, dynamicHeight);  //.resize()

  var canvas = container.canvas().chart("FinalChart", container.info());

  data.children = swapChildren(data.children);

  data.x0 = container.info().canvasH / 2;
  data.y0 = 0;

  //render it with some data
  canvas.draw(data);

  // recursive replace the children nodes to show its elements
  function swapChildren (arr, d) {
    return d3ma.map(arr, function (eachD) {
      // initial loading does not contain "d" argument
      // "d" should be fulfilled when user clicked on a node
      if (!d) {
        if (eachD.children) {
          eachD._children = eachD.children;
          eachD.children = null;
          // recursive calling its children to collapse its children
          swapChildren(eachD._children);
        }
      } else {
        // Only manipulate the clicked on node, ignore the non-clicked nodes
        // but sometimes it could be the children of "eachD", check in "else" statement
        if (d.name === eachD.name) {
          if (d._children) {
            // should expand the tree
            if (eachD.name === d.name) {
              if (eachD._children) {
                eachD.children = eachD._children;
                eachD._children = null;
              }
            } else if (eachD.name === d.parent.name) {
              swapChildren(eachD.children, d);
            }
          } else if (d.children) {
            // should collapse the tree
            eachD._children = eachD.children;
            eachD.children = null;
            // recursive close all its own expanded children
            // swapChildren(eachD.children);
          }
        } else {
          // if the "eachD" is already expanded, so we need to check
          // its children to see if it is the children of the "eachD"'s children
          if (eachD.children) {
            swapChildren(eachD.children, d);
          }
        }
      }
      return eachD;
    });
  }

  // Toggle children on click.
  function click (d) {
    var clickedElement = {
      name: d.name,
      x0:   d.x0,
      y0:   d.y0
    };
    data['clickedElement'] = clickedElement;

    data.children = swapChildren(data.children, d);

    canvas.draw(data);
  }

  // d3.csv("/api/gov.csv", function(d) {
  //   // console.log('d: ', d);
  //   return {

  //   };
  // }, function(error, rows) {
  //   console.log(rows);
  // });

</script>

<!-- livereload snippet  -->
<script src="http://localhost:35729/livereload.js?snipver=1"></script>


</body>
</html>
